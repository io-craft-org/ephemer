{% extends 'base.html' %}

{% block javascript %}
<script defer src="https://unpkg.com/alpinejs@3.4.2/dist/cdn.min.js"></script>


<script>
 document.addEventListener('alpine:init', () => {
     Alpine.data('session', () => ({
         init() {
             this.refreshState(interval=2000)
         },

         error: false,
         refreshState(interval=0) {
             session_this = this
             setInterval(function(){
                 fetch('{{ request.scheme }}://{{ request.get_host }}{% url 'experiments-session-participants-state-json' session.pk %}')
                     .then(res => res.json())
                     .then(data => {
                         session_this.error = false;
                         session_this.participants = data;
                     })
                     .catch((error) => {
                         session_this.error = "Erreur de connexion à oTree";
                     });
             }, interval);
         },
         participants: [],
         toggle() {
             this.open = ! this.open
         }
     }))
 });
</script>
{% endblock %}

{% load bootstrap_icons %}

{% block content %}
<div class="col-11 mx-auto py-4">

    <h3>Expérience en cours : {{ session.name }}</h3>

    <p>
        {% if otree_session %}
        <span class="badge bg-success">Session en cours</span>
        {% else %}
        <span class="badge bg-danger">Session non joignable</span>
        {% endif %}
    </p>

    {% if otree_session %}

    <div class="row my-5 align-items-center justify-content-center">
        <div class="col-4 ">
            <div class="px-5">
                Les participants peuvent accéder à l'expérience en indiquant le code dans l'onglet « Accès participant » :
            </div>
        </div>
        <div class="col-3">
            <div class="bg-light rounded p-3">
                <span class="fs-4 px-4">Code d'accès :</span>
                <span class="fs-3 bg-white rounded p-2">
                    {{ session.pin_code }}
                </span>
            </div>
        </div>
    </div>


    <div x-data="session">
        <div x-show="error" x-transition class="alert alert-warning" style="display:none;" role="alert">
            {% bs_icon 'exclamation-triangle' size='1.5em' extra_classes="align-middle" %}
            <span class="align-middle ms-2" x-text="error"></span>
        </div>
        <table class="table">
            <tr>
                <th>
                    Identifiant participant
                </th>
                <th>
                    Connecté ?
                </th>
                <th>
                    Étape en cours
                </th>
                <th>
                    Terminé ?
                </th>
                <th>
                    Faire avancer
                </th>
            </tr>
            <template x-for="participant in participants">
                <tr>
                    <td x-text="participant.id_in_session"></td>
                    <td x-text="participant.last_page_timestamp"></td>
                    <td x-text="participant.current_page_name"></td>
                    <td x-text="participant.finished"></td>
                    <td><button type="btn btn-secondary">Avancer</button></td>
                </tr>
            </template>
        </table>
    </div>

    <p>
        Adresse de participation : <a href="{{ request.scheme }}://{{ request.get_host }}{% url 'experiments-session-join' session.pk %}" target="_new">{{ request.scheme }}://{{ request.get_host }}{% url 'experiments-session-join' session.pk %}</a>

    </p>

    <div>
        DEBUG OTREE
        <ul>
            <li># de partcipants : {{ otree_session.num_participants }}</li>
            <li>Lien de participation : {{ otree_session.participant_link }}</li>
            <li>Participants:
                <ul>
                    {% for participant in otree_session.participants %}
                    <li>
                        #{{ participant.id_in_session }} / Code: {{ participant.access_code }}
                    </li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </div>
    {% else %}
    <br>
    Il est possible que ce soit temporaire, n'hésitez pas à réessayer d'ici quelques minutes
    {% endif %}

</div>

{% endblock %}
